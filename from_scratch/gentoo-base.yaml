#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: Debian generic recipe using the netinstall mechanim
#
# USAGE:
#   Select directly in this recipe: see usage example commented in the global of
#   this recipe
#
#   or, override the globals directly in CLI. For example:
#
#   kameleon build --global distrib:debian,release:wheezy
#
#   or extends this recipe with your own and override those variable in it.
#
#==============================================================================
---
extend: base.yaml

global:
  # Boilerplate values, so that `kameleon info' works with the recipe.
  # For a specific version of Debian, please see the dedicated recipe, as this
  # recipe is mainly meant as being extended.
  distrib: gentoo
  iso_arch: amd64
  release: NA
  release_number: NA

  # mirror: http://distfiles.gentoo.org/releases/
  # mirror: http://gentoo.mirrors.ovh.net/gentoo-distfiles/
  mirror: http://gentoo.modulix.net/gentoo/

  iso_url:
  iso_finder_helper: $${kameleon_data_dir}/helpers/netinstall_iso_finder.py
  iso_finder_args: $${distrib} $${release_number} $${iso_arch} $${mirror}
  iso_path: $${kameleon_cwd}/$${distrib}.iso

  root_password: root
  qemu_memory_size: 8192
  qemu_image_size: 8G

  qemu_sendkeys_before_boot: $${kameleon_data_dir}/qemu-sendkeys/netinst-iso-$${distrib}

  out_context:
    cmd: sshpass -p 'kameleon_root' ssh -F $${ssh_config_file} $${kameleon_recipe_name} -t /bin/bash
    workdir: /root/kameleon_workdir
    proxy_cache: $${local_ip}

  in_context:
    cmd: ssh -F $${ssh_config_file} $${kameleon_recipe_name} -t chroot $${rootfs} /bin/bash
    workdir: /root/kameleon_workdir
    proxy_cache: $${local_ip}


bootstrap:
  - enable_checkpoint
  - download_iso
  - prepare_disk
  - prepare_ssh_to_out_context
#  - prepare_autoinstall
#  - start_http_server
  - start_qemu:
    - force_vm_shutdown: true
    # - shutdown_vm_immediately: true
    # - vm_cleanup_section: bootstrap
    - vm_expected_service:
    # - boot_timeout: 5

#  - "@base"
  # From debian-base-debootstrap
  # - enable_checkpoint
  # - download_iso
  # - prepare_disk
  # - prepare_ssh_to_out_context
  # - start_qemu
  # - install_build_packages
  # - debootstrap
  # - start_chroot

# setup:
#   - "@base"

# export:
#   - "@base"
